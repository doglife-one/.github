#!/usr/bin/env node
/**
 * WBS Generate: ux-design/epics/*.yaml â†’ project-management/WBS.md
 *
 * Epicå®šç¾©ã‹ã‚‰WBSï¼ˆWork Breakdown Structureï¼‰ã‚’è‡ªå‹•ç”Ÿæˆ
 */

const { execSync } = require('child_process');
const fs = require('fs');
const yaml = require('yaml');

const UX_REPO = 'doglife-one/doglife-ux-design';

// ========== Helper Functions ==========

function getEpicFiles() {
  try {
    const result = execSync(
      `gh api repos/${UX_REPO}/contents/epics --jq '[.[] | select(.name | endswith(".yaml")) | .name]'`,
      { encoding: 'utf-8' }
    );
    return JSON.parse(result);
  } catch {
    return [];
  }
}

function getEpicContent(filename) {
  try {
    const result = execSync(
      `gh api repos/${UX_REPO}/contents/epics/${filename} --jq '.content'`,
      { encoding: 'utf-8' }
    );
    const content = Buffer.from(result.trim(), 'base64').toString('utf-8');
    return yaml.parse(content);
  } catch (e) {
    console.error(`Failed to get ${filename}:`, e.message);
    return null;
  }
}

// ========== Main ==========

async function main() {
  console.log('ðŸ“Š Generating WBS from Epic definitions...\n');

  const files = getEpicFiles();
  console.log(`Found ${files.length} Epic files\n`);

  const epics = [];
  for (const file of files) {
    const epic = getEpicContent(file);
    if (epic) {
      epics.push(epic);
    }
  }

  // ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ž
  const categories = {
    'æ©Ÿèƒ½Epic': epics.filter(e => !e.id.startsWith('TMS-') && !e.id.startsWith('B')),
    'TMSé€£æº': epics.filter(e => e.id.startsWith('TMS-')),
    'ãƒ“ã‚¸ãƒã‚¹': epics.filter(e => e.id.startsWith('B'))
  };

  // WBSç”Ÿæˆ
  let wbs = `# WBS (Work Breakdown Structure)\n\n`;
  wbs += `> è‡ªå‹•ç”Ÿæˆ: ${new Date().toISOString().split('T')[0]}\n`;
  wbs += `> ã‚½ãƒ¼ã‚¹: [ux-design/epics/](https://github.com/${UX_REPO}/tree/main/epics)\n\n`;

  // ã‚µãƒžãƒªãƒ¼
  wbs += `## ã‚µãƒžãƒªãƒ¼\n\n`;
  wbs += `| ã‚«ãƒ†ã‚´ãƒª | Epicæ•° | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |\n`;
  wbs += `|---------|:------:|----------|\n`;
  for (const [cat, list] of Object.entries(categories)) {
    const active = list.filter(e => e.status === 'active').length;
    wbs += `| ${cat} | ${list.length} | Active: ${active} |\n`;
  }
  wbs += `\n`;

  // å„ªå…ˆåº¦åˆ¥
  wbs += `## å„ªå…ˆåº¦åˆ¥\n\n`;
  const priorities = ['critical', 'high', 'medium', 'low'];
  for (const priority of priorities) {
    const list = epics.filter(e => e.priority === priority);
    if (list.length > 0) {
      wbs += `### ${priority.toUpperCase()} (${list.length})\n\n`;
      for (const e of list) {
        wbs += `- **${e.id}**: ${e.title}\n`;
      }
      wbs += `\n`;
    }
  }

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥è©³ç´°
  for (const [cat, list] of Object.entries(categories)) {
    wbs += `## ${cat}\n\n`;
    wbs += `| ID | ã‚¿ã‚¤ãƒˆãƒ« | å„ªå…ˆåº¦ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å¯¾è±¡ | ä¾å­˜ |\n`;
    wbs += `|----|---------|:------:|:--------:|------|------|\n`;

    // IDã§ã‚½ãƒ¼ãƒˆ
    list.sort((a, b) => a.id.localeCompare(b.id));

    for (const e of list) {
      const targets = (e.target || []).join(', ');
      const deps = (e.dependencies || []).join(', ') || '-';
      wbs += `| ${e.id} | ${e.title} | ${e.priority} | ${e.status} | ${targets} | ${deps} |\n`;
    }
    wbs += `\n`;
  }

  // Storyç´ä»˜ã‘
  wbs += `## Epic Ã— Story ãƒžãƒƒãƒ”ãƒ³ã‚°\n\n`;
  wbs += `| Epic | Stories |\n`;
  wbs += `|------|--------|\n`;
  for (const e of epics.sort((a, b) => a.id.localeCompare(b.id))) {
    const stories = (e.stories || []).join(', ') || '-';
    wbs += `| ${e.id} | ${stories} |\n`;
  }
  wbs += `\n`;

  // ä¾å­˜é–¢ä¿‚å›³
  wbs += `## ä¾å­˜é–¢ä¿‚\n\n`;
  wbs += '```mermaid\n';
  wbs += 'graph LR\n';
  for (const e of epics) {
    if (e.dependencies && e.dependencies.length > 0) {
      for (const dep of e.dependencies) {
        wbs += `  ${dep} --> ${e.id}\n`;
      }
    }
  }
  wbs += '```\n\n';

  wbs += `---\n\n`;
  wbs += `ðŸ¤– Auto-generated by [WBS Generate](https://github.com/doglife-one/.github/actions)\n`;

  fs.writeFileSync('WBS.md', wbs);
  console.log('âœ… WBS.md generated successfully');
  console.log(`Total Epics: ${epics.length}`);
}

main().catch(e => {
  console.error(e);
  process.exit(1);
});
